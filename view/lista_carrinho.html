<html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="img/icons/vector_sol.jpg" type="image/png">

  <title>Eternal-sunshine</title>
  <link rel="stylesheet" href="../css/lista_carrinho.css" />
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
</head>

<body>
    <header>
        <a href="../index.html"><h1>Eternal Sunshine</h1></a>
        <div class="header-search" bis_skinchecked="1">
        </div>
    </header>
    <main>
      <h1 class="page-title">Seu Carrinho</h1>
    <div class="container">  
      <div class="empty-cart"> 
        <div class="emot">
          <img src="https://public-resources.zordcdn.com.br/assets/global/checkout-v2/empty-cart-new.svg" 
          width="426" height="280" alt="Carrinho de compras">
        </div> 
          <h3>Carrinho vazio</h3>
          <p class="txt-empty">
          Que tal olhar nossos produtos e receber seu pedido na porta de casa?</p>
          <a href="../index.html" id="voltar">Voltar as compras</a>
      </div> 
    </div>
    </main>
      </div> 
    </div>



    <script>
    
      const firebaseConfig = {
        apiKey: "AIzaSyDKROCfYUdEzG8gCkjVYGfHwDHsGhvu7ZA",
        authDomain: "clothingsales-2ace7.firebaseapp.com",
        projectId: "clothingsales-2ace7",
        storageBucket: "clothingsales-2ace7.appspot.com",
        messagingSenderId: "856958563843",
        appId: "1:856958563843:web:7758d4e8948316a5e44036"
      };
  
      firebase.initializeApp(firebaseConfig);
  
      const db = firebase.firestore();
  
      // Verifica se o usuário está autenticado
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          listarProdutosCarrinho(user.uid);
        } else {
          window.location.href = './view/login.html';
        }
      });
  
    
    // Função para listar os produtos no carrinho do usuário
    function listarProdutosCarrinho(userId) {
      const carrinhoRef = db.collection('usuarios').doc(userId).collection('carrinho');

      carrinhoRef.get().then((querySnapshot) => {
        if (querySnapshot.empty) {
          // O carrinho está vazio
          exibirCarrinhoVazio();
        } else {
          // O carrinho contém produtos
          const produtosPromises = [];
          querySnapshot.forEach((doc) => {
            const produtoId = doc.data().produtoId;
            const quantidade = doc.data().quantidade;
            // Para cada produto no carrinho, obtem os detalhes do produto do banco de dados
            const produtoPromiseMasculino = db.collection('Roupas').doc('Masculino').collection('Adulto').doc(produtoId).get();
            const produtoPromiseFeminino = db.collection('Roupas').doc('Feminino').collection('Adulto').doc(produtoId).get();

            produtosPromises.push(produtoPromiseMasculino);
            produtosPromises.push(produtoPromiseFeminino);
          });

          // Aguarde todas as consultas serem resolvidas
          Promise.all(produtosPromises).then((produtosSnapshots) => {
            const produtos = [];
            produtosSnapshots.forEach((produtoSnapshot) => {
              if (produtoSnapshot.exists) { // Verifica se o documento existe
                produtos.push(produtoSnapshot.data());
              } else {
                console.error('Erro ao obter detalhes dos produtos:', 'Documento não encontrado');
              }
            });
            // Exiba os produtos na página
            exibirProdutosNoCarrinho(produtos);
          }).catch((error) => {
            console.error('Erro ao obter detalhes dos produtos:', error);
            // Trate o erro conforme necessário
          });
        }
      }).catch((error) => {
        console.error('Erro ao obter produtos do carrinho:', error);
        // Trate o erro conforme necessário
      });
    }


  
  // Função para exibir os produtos no carrinho na página
  function exibirProdutosNoCarrinho(produtos) {
    const container = document.querySelector('.container');
  
    // Limpa o conteúdo atual do container
    container.innerHTML = '';
  
    // Itera sobre os produtos e os exibe na página
    produtos.forEach((produto) => {
        const produtoHTML = `
          <div class="product-list">
            <div class="product-item">
              <img src="${produto.img}" alt="${produto.img}">
              <div class="product-info">
                <h2>${produto.nome}</h2>
                <p>Preço: ${produto.valor}</p>
                <div class="product-controls">
                  <button class="quantity-btn" onclick="diminuirQuantidade('${produto.id}')">-</button>
                  <span class="quantity">1</span>
                  <button class="quantity-btn" onclick="aumentarQuantidade('${produto.id}')">+</button>
                  <button class="remove-btn" onclick="removerDoCarrinho('${produto.id}')">Remover</button>
                </div>
              </div>
            </div>
          </div>
        `;
        container.innerHTML += produtoHTML;
      });
    }
    
  
    </script>
  </body>
</html>